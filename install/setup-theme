#!/bin/bash

set -e

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
source "$SCRIPT_DIR/lib/helpers.sh"

# Dynamically set DOTFILES_DIR to the parent of the 'install' directory
DOTFILES_DIR=$(cd "$SCRIPT_DIR/.." && pwd)

# Set initial theme to matte-black
log_info "Setting up initial theme (matte-black)..."

# Create a 'current' directory inside the dotfiles repo to track the active theme
mkdir -p "$DOTFILES_DIR/current"

# Link the matte-black theme and a default background as the 'current' ones
ln -snf "$DOTFILES_DIR/themes/matte-black" "$DOTFILES_DIR/current/theme"
ln -snf "$DOTFILES_DIR/current/theme/backgrounds/black-hole.jpg" "$DOTFILES_DIR/current/background"

# Create necessary config directories for theme files
mkdir -p "$HOME/.config/nvim/lua/plugins"
mkdir -p "$HOME/.config/btop/themes"
mkdir -p "$HOME/.config/mako"

# Symlink the theme files for various applications
ln -snf "$DOTFILES_DIR/current/theme/neovim.lua" "$HOME/.config/nvim/lua/plugins/theme.lua"
ln -snf "$DOTFILES_DIR/current/theme/btop.theme" "$HOME/.config/btop/themes/current.theme"
ln -snf "$DOTFILES_DIR/current/theme/mako.ini" "$HOME/.config/mako/config"

# Symlink the fastfetch configuration
mkdir -p "$HOME/.config/fastfetch"
ln -snf "$DOTFILES_DIR/config/fastfetch/configs/config-default.jsonc" "$HOME/.config/fastfetch/config.jsonc"

# Symlink the wallpapers directory to the user's Pictures folder for easy access
log_info "Setting up wallpapers symlink..."
mkdir -p "$HOME/Pictures"
if [ -L "$HOME/Pictures/Wallpapers" ] || [ -d "$HOME/Pictures/Wallpapers" ]; then
  # Backup any existing Wallpapers folder
  mv "$HOME/Pictures/Wallpapers" "$HOME/Pictures/Wallpapers-backup"
fi
ln -sf "$DOTFILES_DIR/backgrounds" "$HOME/Pictures/Wallpapers"
log_detail "Wallpapers symlinked to ~/Pictures/Wallpapers"

# Apply GTK and font settings
gsettings set org.gnome.desktop.interface icon-theme "Yaru-sage"
gsettings set org.gnome.desktop.interface font-name 'CaskaydiaMono Nerd Font Mono 11'
gsettings set org.gnome.desktop.interface monospace-font-name 'CaskaydiaMono Nerd Font Mono 11'

log_success "Initial theme set (matte-black)"
