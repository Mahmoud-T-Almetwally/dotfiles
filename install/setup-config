#!/bin/bash

set -e

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
source "$SCRIPT_DIR/lib/helpers.sh"
source "$SCRIPT_DIR/lib/backup.sh"

# Dynamically set DOTFILES_DIR to the parent directory of 'install'
# This makes it robust and not dependent on a hardcoded path.
DOTFILES_DIR=$(cd "$SCRIPT_DIR/.." && pwd)

log_info "Backing up existing config files from ~/.config..."

# Collect all targets that will be affected
TARGETS=()
for item in "$DOTFILES_DIR/config"/*; do
  if [ -e "$item" ]; then
    item_name=$(basename "$item")
    TARGETS+=("$HOME/.config/$item_name")
  fi
done

# Backup any existing files that would be overwritten
for target in "${TARGETS[@]}"; do
  if [ -e "$target" ]; then
    backup_file "$target" || {
      log_error "Failed to backup $(basename "$target")"
      exit 1
    }
  fi
done

# Remove the old files before copying the new ones
for target in "${TARGETS[@]}"; do
  remove_path "$target"
done

#### Setting up kvantum custom theme

log_info "Linking custom Kvantum theme..."
# Ensure the base Kvantum config directory exists
mkdir -p "$HOME/.config/Kvantum"

# Define the source in your dotfiles and the target in the system config
KVANTUM_THEME_SOURCE="$DOTFILES_DIR/config/Kvantum/KvHypr"
KVANTUM_THEME_TARGET="$HOME/.config/Kvantum/KvHypr"

# If a theme already exists at the target, back it up and remove it
if [ -e "$KVANTUM_THEME_TARGET" ]; then
    backup_file "$KVANTUM_THEME_TARGET"
    remove_path "$KVANTUM_THEME_TARGET"
fi

# Create the symbolic link
ln -s "$KVANTUM_THEME_SOURCE" "$KVANTUM_THEME_TARGET"
log_success "Kvantum theme 'KvHypr' linked."

log_info "Setting default Kvantum theme..."

# Define the source and target paths for the main Kvantum config
KVANTUM_CONFIG_SOURCE="$DOTFILES_DIR/config/Kvantum/kvantum.kvconfig"
KVANTUM_CONFIG_TARGET="$HOME/.config/Kvantum/kvantum.kvconfig"

# Ensure the directory exists
mkdir -p "$HOME/.config/Kvantum"

# Backup and remove any existing Kvantum master config
if [ -e "$KVANTUM_CONFIG_TARGET" ]; then
    backup_file "$KVANTUM_CONFIG_TARGET"
    remove_path "$KVANTUM_CONFIG_TARGET"
fi

# Copy the new master config file into place
cp "$KVANTUM_CONFIG_SOURCE" "$KVANTUM_CONFIG_TARGET"
log_success "Default Kvantum theme set to 'KvHypr'."

#### setting Icon theme for Qt apps

log_info "Copying Qt theme configuration..."

mkdir -p "$HOME/.config/qt6ct"

if [ -f "$DOTFILES_DIR/config/qt6ct/qt6ct.conf" ]; then
    cp "$DOTFILES_DIR/config/qt6ct/qt6ct.conf" "$HOME/.config/qt6ct/qt6ct.conf"
fi

# Copy the new configuration files from the dotfiles repo
cp -r "$DOTFILES_DIR/config/"* "$HOME/.config/"
log_success "New config files copied to ~/.config/"

# Create GTK theme symlinks pointing to the new dotfiles location
echo "@import url(\"file://$DOTFILES_DIR/current/theme/gtk.css\");" >"$HOME/.config/gtk-3.0/gtk.css"
echo "@import url(\"file://$DOTFILES_DIR/current/theme/gtk.css\");" >"$HOME/.config/gtk-4.0/gtk.css"
log_info "GTK theme links created."

# Create Tinte settings file with updated paths
mkdir -p "$HOME/.config/tinte"
[ -f "$HOME/.config/tinte/settings.json" ] && rm -f "$HOME/.config/tinte/settings.json"
cat > "$HOME/.config/tinte/settings.json" << EOF
{
  "wallpaperFolder": "$HOME/Pictures/Wallpapers",
  "posthookScript": "theme-set",
  "exportThemeLocation": "$HOME/.config/tinte/exported-themes",
  "applyThemeLocation": "$DOTFILES_DIR/themes/tinte",
  "colorBackend": "imagemagick",
  "wallpaperBackend": "hyprpaper"
}
EOF
log_success "Tinte configuration created."

# These lines are already in the main install script, so they are not needed here.
# log_info "Backup saved to: $BACKUP_DIR"
# log_info "Restore instructions: cat $RESTORE_FILE"
