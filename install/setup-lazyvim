#!/bin/bash
set -e

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
source "$SCRIPT_DIR/lib/helpers.sh"
source "$SCRIPT_DIR/lib/backup.sh"

# Dynamically set DOTFILES_DIR to the parent of the 'install' directory
DOTFILES_DIR=$(cd "$SCRIPT_DIR/.." && pwd)

# Backup existing Neovim configuration if it exists
if [ -d "$HOME/.config/nvim" ] || [ -L "$HOME/.config/nvim" ]; then
  log_info "Existing nvim config found, backing up..."
  if [ -e "$HOME/.config/nvim" ]; then
    backup_file "$HOME/.config/nvim" || {
      log_error "Failed to backup nvim config"
      exit 1
    }
  fi
  remove_path "$HOME/.config/nvim"
fi

# Clone the LazyVim starter template
if ! git clone https://github.com/LazyVim/starter ~/.config/nvim; then
  log_error "Failed to clone LazyVim starter"
  exit 1
fi
rm -rf ~/.config/nvim/.git
log_info "LazyVim starter cloned"

# Copy your custom configurations over the starter template
if [ -d "$DOTFILES_DIR/default/nvim" ]; then
  cp -r "$DOTFILES_DIR/default/nvim"/* "$HOME/.config/nvim/"
else
  # This provides a clearer error message
  log_error "Could not find custom nvim configs in $DOTFILES_DIR/default/nvim"
  exit 1
fi

# Append custom options to options.lua
# This part is unchanged and adds your specific settings
cat >> "$HOME/.config/nvim/lua/config/options.lua" <<'EOF'

local opt = vim.opt

opt.number = true -- Show absolute line numbers
opt.relativenumber = false -- Disable relative line numbers
EOF

log_success "LazyVim setup finished!"
