#!/bin/bash

set -e

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
source "$SCRIPT_DIR/lib/helpers.sh"
source "$SCRIPT_DIR/lib/backup.sh"

# Dynamically set DOTFILES_DIR to the parent of the 'install' directory
DOTFILES_DIR=$(cd "$SCRIPT_DIR/.." && pwd)

# Configure gnome-keyring PAM
log_info "Configuring gnome-keyring PAM integration..."

[ -f "/etc/pam.d/login" ] && backup_file "/etc/pam.d/login"
[ -f "/etc/pam.d/passwd" ] && backup_file "/etc/pam.d/passwd"

# Configure /etc/pam.d/login
if ! grep -q "pam_gnome_keyring.so" /etc/pam.d/login; then
  sudo sed -i '/auth.*include.*system-local-login/a auth       optional     pam_gnome_keyring.so' /etc/pam.d/login
  sudo sed -i '/session.*include.*system-local-login/a session    optional     pam_gnome_keyring.so auto_start' /etc/pam.d/login
fi

# Configure /etc/pam.d/passwd
if ! grep -q "pam_gnome_keyring.so" /etc/pam.d/passwd; then
  echo "password	optional	pam_gnome_keyring.so" | sudo tee -a /etc/pam.d/passwd >/dev/null
fi

log_success "gnome-keyring PAM configured"

# Configure pacman.conf
log_info "Configuring pacman.conf..."
PACMAN_CONF="/etc/pacman.conf"

[ -f "$PACMAN_CONF" ] && backup_file "$PACMAN_CONF"
# This now copies from the correct ~/dotfiles location
sudo cp "$DOTFILES_DIR/default/pacman/pacman.conf" "$PACMAN_CONF"
log_success "pacman.conf configured"

# Configure UFW
if is_installed "ufw"; then
  log_info "Configuring UFW..."
  sudo ufw default deny incoming
  sudo ufw default allow outgoing
  sudo ufw allow 53317/udp comment 'LocalSend'
  sudo ufw allow 53317/tcp comment 'LocalSend'
  sudo ufw allow 22/tcp comment 'SSH'
  sudo ufw --force enable
  sudo systemctl enable ufw
  log_success "UFW configured and enabled"
else
  log_detail "UFW not installed, skipping firewall configuration"
fi

# Detect and configure NVIDIA if present
if has_nvidia_gpu; then
  log_info "NVIDIA GPU detected, configuring for Hyprland..."
  bash "$SCRIPT_DIR/setup-nvidia"
fi

# Configure git user
log_info "Configuring git user information..."

CURRENT_GIT_NAME=$(git config --global user.name 2>/dev/null || true)
CURRENT_GIT_EMAIL=$(git config --global user.email 2>/dev/null || true)

if [ -n "$CURRENT_GIT_NAME" ] && [ -n "$CURRENT_GIT_EMAIL" ]; then
  log_detail "Git already configured:"
  log_detail "  Name:  $CURRENT_GIT_NAME"
  log_detail "  Email: $CURRENT_GIT_EMAIL"

  if ask_yes_no "Update git config?"; then
    CURRENT_GIT_NAME=""
    CURRENT_GIT_EMAIL=""
  fi
fi

if [ -z "$CURRENT_GIT_NAME" ]; then
  if _has_gum; then
    GIT_NAME=$(gum input --placeholder "Enter your name (used for git)" || true)
  else
    read -p "Enter your name: " GIT_NAME
  fi

  if [ -n "$GIT_NAME" ]; then
    git config --global user.name "$GIT_NAME"
    log_success "Set git user.name: $GIT_NAME"
  fi
fi

if [ -z "$CURRENT_GIT_EMAIL" ]; then
  if _has_gum; then
    GIT_EMAIL=$(gum input --placeholder "Enter your email (used for git)" || true)
  else
    read -p "Enter your email: " GIT_EMAIL
  fi

  if [ -n "$GIT_EMAIL" ]; then
    git config --global user.email "$GIT_EMAIL"
    log_success "Set git user.email: $GIT_EMAIL"
  fi
fi

# Configure SDDM display manager instead of Ly
if is_installed "sddm"; then
  log_info "Configuring SDDM display manager..."
  
  # Enable the SDDM service
  sudo systemctl enable sddm.service
  
  # Copy the theme configuration
  # IMPORTANT: You must create this file in your repository.
  SDDM_CONF_DIR="/etc/sddm.conf.d"
  SDDM_THEME_FILE="theme.conf"
  
  sudo mkdir -p "$SDDM_CONF_DIR"
  if [ -f "$DOTFILES_DIR/default/sddm/$SDDM_THEME_FILE" ]; then
    [ -f "$SDDM_CONF_DIR/$SDDM_THEME_FILE" ] && backup_file "$SDDM_CONF_DIR/$SDDM_THEME_FILE"
    sudo cp "$DOTFILES_DIR/default/sddm/$SDDM_THEME_FILE" "$SDDM_CONF_DIR/$SDDM_THEME_FILE"
    log_success "SDDM theme configured."
  else
    log_detail "No SDDM theme file found in your repo, skipping theme setup."
  fi
else
  log_detail "sddm not installed, skipping display manager configuration."
fi

# Enable NetworkManager and iwd services
log_info "Configuring network services..."
sudo systemctl enable NetworkManager.service
sudo systemctl enable iwd.service

# Configure NetworkManager to use iwd as the Wi-Fi backend
NM_CONF_DIR="/etc/NetworkManager/conf.d"
WIFI_BACKEND_CONF="wifi_backend.conf"
sudo mkdir -p "$NM_CONF_DIR"
echo -e "[device]\nwifi.backend=iwd" | sudo tee "$NM_CONF_DIR/$WIFI_BACKEND_CONF" > /dev/null
log_success "NetworkManager configured to use iwd."

# Disable wait on network from system startup (optional, speeds up boot)
log_info "Disabling systemd-networkd-wait-online.service..."
sudo systemctl disable systemd-networkd-wait-online.service 2>/dev/null || true

# Enable ssh agent
log_info "Enabling gcr-ssh-agent"
systemctl --user enable --now gcr-ssh-agent.socket

# Setup systemd user services
log_info "Setting up systemd user services..."
mkdir -p "$HOME/.config/systemd/user"

if [ -d "$DOTFILES_DIR/default/systemd/user" ]; then
  cp -f "$DOTFILES_DIR/default/systemd/user/"*.service "$HOME/.config/systemd/user/" 2>/dev/null || true
  log_detail "Service files copied"
fi

systemctl --user daemon-reload 2>/dev/null || log_detail "Failed to reload systemd"

USER_SERVICES=(
  "elephant.service"
  "hypridle.service"
  "mako.service"
  "sunsetr.service"
  "swayosd.service"
  "walker.service"
  "waybar.service"
  "hyprpaper.service"
)

for service in "${USER_SERVICES[@]}"; do
  if [ -f "$HOME/.config/systemd/user/$service" ]; then
    systemctl --user enable "$service" &>/dev/null && log_detail "$service enabled" || log_detail "$service (already enabled)"
  else
    log_detail "$service (service file not found)"
  fi
done

log_detail "Services will start on next login or Hyprland restart"

log_success "System configuration complete!"
